<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <title>AULA AO VIVO - ZOOM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root { 
        --bg1: #022f66; 
        --bg2: #16a37b; 
        --card: #ffffff; 
        --txt: #0c2b3a; 
        --muted: #6b7680; 
      }
      
      html, body {
        height: 100%;
        margin: 0;
      }
      
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial, sans-serif;
        color: var(--txt);
        background: linear-gradient(130deg, var(--bg1), var(--bg2)) fixed;
        display: grid;
        place-items: center;
        padding: 20px;
      }
      
      .card {
        width: min(92vw, 480px);
        background: var(--card);
        border-radius: 20px;
        padding: 40px 32px;
        box-shadow: 0 30px 60px rgba(0, 0, 0, .25);
      }
      
      h1 {
        margin: 0 0 8px;
        font-size: 28px;
        font-weight: 700;
        letter-spacing: 0.3px;
        line-height: 1.2;
        text-align: center;
      }
      
      p.sub {
        margin: 0 0 24px;
        color: var(--muted);
        font-size: 15px;
        line-height: 1.5;
        text-align: center;
      }
      
      label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        margin: 0 0 8px;
        color: var(--txt);
      }
      
      .form-group {
        margin-bottom: 20px;
      }
      
      input {
        width: 100%;
        height: 48px;
        padding: 12px 16px;
        font-size: 16px;
        border: 2px solid #d7dee3;
        border-radius: 12px;
        outline: none;
        box-sizing: border-box;
        transition: all 0.2s ease;
      }
      
      input:focus {
        border-color: #0e77cc;
        box-shadow: 0 0 0 4px rgba(14, 119, 204, .12);
      }
      
      input::placeholder {
        color: #a0aec0;
      }
      
      .btn {
        width: 100%;
        height: 52px;
        border: 0;
        border-radius: 12px;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        margin-top: 28px;
        background: linear-gradient(90deg, #0e77cc, #17a460);
        color: #fff;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(14, 119, 204, .3);
      }
      
      .btn:active {
        transform: translateY(0);
      }
      
      .foot {
        margin-top: 16px;
        text-align: center;
        color: #e6f2ff;
        font-size: 14px;
        font-weight: 500;
      }

      /* === LOADER (Uiverse â€“ Nawsome) + overlay === */
      .loader {
        --background: linear-gradient(135deg, #23C4F8, #275EFE);
        --shadow: rgba(39, 94, 254, 0.28);
        --text: #6C7486;
        --page: rgba(255, 255, 255, 0.36);
        --page-fold: rgba(255, 255, 255, 0.52);
        --duration: 3s;
        width: 200px;
        height: 140px;
        position: relative;
      }
      .loader:before, .loader:after {
        --r: -6deg;
        content: "";
        position: absolute;
        bottom: 8px;
        width: 120px;
        top: 80%;
        box-shadow: 0 16px 12px var(--shadow);
        transform: rotate(var(--r));
      }
      .loader:before { left: 4px; }
      .loader:after  { --r: 6deg; right: 4px; }
      .loader div {
        width: 100%; height: 100%; border-radius: 13px; position: relative; z-index: 1;
        perspective: 600px; box-shadow: 0 4px 6px var(--shadow); background-image: var(--background);
      }
      .loader div ul { margin: 0; padding: 0; list-style: none; position: relative; }
      .loader div ul li {
        --r: 180deg; --o: 0; --c: var(--page);
        position: absolute; top: 10px; left: 10px; transform-origin: 100% 50%;
        color: var(--c); opacity: var(--o); transform: rotateY(var(--r)); animation: var(--duration) ease infinite;
      }
      .loader div ul li:nth-child(2){ --c: var(--page-fold); animation-name: page-2; }
      .loader div ul li:nth-child(3){ --c: var(--page-fold); animation-name: page-3; }
      .loader div ul li:nth-child(4){ --c: var(--page-fold); animation-name: page-4; }
      .loader div ul li:nth-child(5){ --c: var(--page-fold); animation-name: page-5; }
      .loader div ul li svg { width: 90px; height: 120px; display: block; }
      .loader div ul li:first-child { --r: 0deg; --o: 1; }
      .loader div ul li:last-child  { --o: 1; }
      .loader span { display: block; left: 0; right: 0; top: 100%; margin-top: 20px; text-align: center; color: var(--text); }

      @keyframes page-2 { 0%{transform:rotateY(180deg);opacity:0} 20%{opacity:1} 35%,100%{opacity:0} 50%,100%{transform:rotateY(0deg)} }
      @keyframes page-3 { 15%{transform:rotateY(180deg);opacity:0} 35%{opacity:1} 50%,100%{opacity:0} 65%,100%{transform:rotateY(0deg)} }
      @keyframes page-4 { 30%{transform:rotateY(180deg);opacity:0} 50%{opacity:1} 65%,100%{opacity:0} 80%,100%{transform:rotateY(0deg)} }
      @keyframes page-5 { 45%{transform:rotateY(180deg);opacity:0} 65%{opacity:1} 80%,100%{opacity:0} 95%,100%{transform:rotateY(0deg)} }

      /* overlay que cobre a tela toda */
      .loading-overlay{
        position: fixed; inset: 0; display: none; place-items: center;
        background: rgba(0,0,0,.35); z-index: 9999; backdrop-filter: blur(2px);
      }
      .loading-overlay.show{ display: grid; }
    </style>
  </head>
  <body>
    <main class="card">
      <h1>AULA AO VIVO</h1>
      <p class="sub">Insira suas credenciais para acessar a aula.</p>

      <form id="loginForm" novalidate>
        <div class="form-group">
          <label for="nome">NOME</label>
          <input 
            id="nome" 
            name="nome" 
            type="text"
            autocomplete="name" 
            placeholder="Insira seu nome completo" 
            required 
          />
        </div>

        <div class="form-group">
          <label for="cpf">CPF</label>
          <input 
            id="cpf"    
            name="cpf" 
            inputmode="numeric" 
            autocomplete="off" 
            placeholder="000.000.000-00" 
          />
        </div>

        <button class="btn" type="submit">Entrar</button>
      </form>
    </main>

    <div class="foot">UniFECAF â€” Seu sonho nossa meta ðŸš€ðŸ’™</div>

    <!-- Overlay de carregamento -->
    <div id="loading" class="loading-overlay" aria-hidden="true">
      <div class="loader" role="status" aria-live="polite">
        <div>
          <ul>
            <li><svg fill="currentColor" viewBox="0 0 90 120"><path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path></svg></li>
            <li><svg fill="currentColor" viewBox="0 0 90 120"><path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path></svg></li>
            <li><svg fill="currentColor" viewBox="0 0 90 120"><path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path></svg></li>
            <li><svg fill="currentColor" viewBox="0 0 90 120"><path d="M90,0 L90,120 L11,120 C4.92486775,120 0,115.075132 0,109 L0,11 C0,4.92486775 4.92486775,0 11,0 L90,0 Z M71.5,81 L18.5,81 C17.1192881,81 16,82.1192881 16,83.5 C16,84.8254834 17.0315359,85.9100387 18.3356243,85.9946823 L18.5,86 L71.5,86 C72.8807119,86 74,84.8807119 74,83.5 C74,82.1745166 72.9684641,81.0899613 71.6643757,81.0053177 L71.5,81 Z M71.5,57 L18.5,57 C17.1192881,57 16,58.1192881 16,59.5 C16,60.8254834 17.0315359,61.9100387 18.3356243,61.9946823 L18.5,62 L71.5,62 C72.8807119,62 74,60.8807119 74,59.5 C74,58.1192881 72.8807119,57 71.5,57 Z M71.5,33 L18.5,33 C17.1192881,33 16,34.1192881 16,35.5 C16,36.8254834 17.0315359,37.9100387 18.3356243,37.9946823 L18.5,38 L71.5,38 C72.8807119,38 74,36.8807119 74,35.5 C74,34.1192881 72.8807119,33 71.5,33 Z"></path></svg></li>
          </ul>
        </div>
        <span>Loading</span>
      </div>
    </div>

    <script>
      // âœ… CONFIGURAR A URL DO SEU BACKEND
      const API_BASE = "https://api-bigquery.app.unifecaf.edu.br";
      const BEARER = "zoom";

      // ðŸ”¹ PEGAR ELEMENTOS ANTES DE USAR
      const nomeInput = document.getElementById("nome");
      const cpfInput  = document.getElementById("cpf");
      const form      = document.getElementById("loginForm");

      // ðŸ”¹ Loader refs (jÃ¡ existem no DOM porque o overlay estÃ¡ acima do script)
      const loadingEl = document.getElementById('loading');
      const btnSubmit = document.querySelector('button[type="submit"]');

      async function enviarCheckin({ nome, cpf, link_zoom }) {
        const resp = await fetch(`${API_BASE}/zoom/checkin`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${BEARER}`
          },
          body: JSON.stringify({
            nome,
            cpf,
            link_zoom,
            ip: (await (await fetch("https://api.ipify.org?format=json")).json()).ip // sÃ³ pra cumprir o schema atual
          })
        });

        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          throw new Error(`Falha no check-in: ${resp.status} ${JSON.stringify(err)}`);
        }
        return resp.json();
      }

      // Pega URL da reuniÃ£o (?u=...)
      const params = new URLSearchParams(location.search);
      const targetEncoded = params.get("u") || "";
      const link_zoom = targetEncoded ? decodeURIComponent(targetEncoded) : "";

      function isAllowedTarget(href) {
        try {
          const u = new URL(href);
          const host = (u.hostname || "").toLowerCase();
          const http = u.protocol === "http:" || u.protocol === "https:";
          const isMeet = host === "meet.google.com";
          const isZoom =
            host === "zoom.us" || host.endsWith(".zoom.us") ||
            host === "zoom.com" || host.endsWith(".zoom.com") ||
            host === "zoomgov.com" || host.endsWith(".zoomgov.com");
          const joinPath = /^\/(j|wc\/join|s)\//.test(u.pathname);
          return http && (isMeet || (isZoom && joinPath));
        } catch (e) { return false; }
      }

      // âœ… NOME: permite letras, espaÃ§os e acentos
      nomeInput.addEventListener("input", function(e) {
        e.target.value = e.target.value.replace(/[<>"';{}()\[\]]/g, '');
      });

      // âœ… CPF: formata enquanto digita
      function formatCPF(v) {
        let s = (v || "").replace(/\D/g, "").slice(0, 11);
        if (s.length > 9)  return s.replace(/(\d{3})(\d{3})(\d{3})(\d{0,2})/, "$1.$2.$3-$4");
        if (s.length > 6)  return s.replace(/(\d{3})(\d{3})(\d{0,3})/, "$1.$2.$3");
        if (s.length > 3)  return s.replace(/(\d{3})(\d{0,3})/, "$1.$2");
        return s;
      }
      cpfInput.addEventListener("input", e => e.target.value = formatCPF(e.target.value));

      // Valida CPF
      function isValidCPFDigits(s) {
        if (!/^\d{11}$/.test(s) || /^(\d)\1{10}$/.test(s)) return false;
        const n = s.split("").map(Number);
        const dv = (arr, f) => {
          let t = 0; for (let i=0;i<arr.length;i++) t += arr[i]*(f-i);
          const m = t % 11; return m < 2 ? 0 : 11 - m;
        };
        return dv(n.slice(0,9),10) === n[9] && dv(n.slice(0,10),11) === n[10];
      }

      // Aviso no console se link invÃ¡lido
      if (!link_zoom || !isAllowedTarget(link_zoom)) {
        console.warn("Link alvo ausente ou nÃ£o permitido:", link_zoom);
      }

      // ðŸ”¹ Mostrar loader no submit (anti-duplo clique)
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const nome = nomeInput.value.trim();
        const cpf  = cpfInput.value.replace(/\D/g, "");

        if (!nome || nome.length < 3) {
          alert("Informe seu nome completo.");
          nomeInput.focus();
          return;
        }
        if (!link_zoom || !isAllowedTarget(link_zoom)) {
          alert("Link da reuniÃ£o invÃ¡lido ou ausente. Acesse pelo mural/aviso correto.");
          return;
        }
        if (cpf && !isValidCPFDigits(cpf)) {
          alert("CPF invÃ¡lido.");
          cpfInput.focus();
          return;
        }

        // mostra overlay e bloqueia botÃ£o
        if (loadingEl) loadingEl.classList.add('show');
        if (btnSubmit) btnSubmit.disabled = true;

        try {
          await enviarCheckin({ nome, cpf, link_zoom });
          window.location.href = link_zoom; // redireciona para o Zoom
        } catch (err) {
          console.error(err);
          alert("NÃ£o foi possÃ­vel realizar o check-in. Tente novamente.");
          if (loadingEl) loadingEl.classList.remove('show');
          if (btnSubmit) btnSubmit.disabled = false;
        }
      });
    </script>
  </body>
</html>
